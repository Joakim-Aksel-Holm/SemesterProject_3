@page "/operator"
@using BeerProduction.Services
@inject DatabaseConnection Db
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<link rel="stylesheet" href="css/operatorStyle.css"/>

@if (_loading)
{
    <div class="loading-box">
        <label><img alt="" src=""/>@_loadingMessage</label>
    </div>
}
@if (!_loading)
{
    <div class="machine-view">
    
    <div class="machine-inventory">
        <ol class="ordered-queue">
        
            <li class="queue-item" >
            <h4 class="BatchId"> BatchId </h4>
            <p>Status: venter</p> 
            </li>


            <li class="queue-item">
            <h4 class="BatchId">BatchId</h4>
            <p>Status: Venter</p>
            </li>

            <li class="queue-item">
            <h4 class="BatchId">BatchId</h4>
            <p>Status: Venter</p>
            </li>
        </ol>
    </div>
    <div class="machine-meter">
        <div class="variables">
            <ul>
                <li>
                    <label>
                        <img class="variable-img" alt="" src=""/>Batch ID: @_machine?.BatchId
                    </label>
                </li>
                <li>
                    <label>
                        <img class="variable-img" alt="" src=""/>Amount to produce: @_machine?.Amount
                    </label>
                </li>
                <li>
                    <label>
                        <img class="variable-img" alt="" src=""/>PPM: @_machine?.PPM
                    </label>
                </li>

                @if (_temperatureCheck)
                {
                    <li>
                        <label>
                            <img class="variable-img" alt="" src=""/>Temperature: @_machine?.Temperature
                        </label>
                    </li>
                }
                @if (_humidityCheck)
                {
                    <li>
                        <label>
                            <img class="variable-img" alt="" src=""/>Humidity: @_machine?.Humidity
                        </label>
                    </li>
                }
                @if (_vibrationCheck)
                {
                    <li>
                        <label>
                            <img class="variable-img" alt="" src=""/>Vibration: @_machine?.Vibration
                        </label>
                    </li>
                }
                @if (_defectsCheck)
                {
                    <li>
                        <label>
                            <img class="variable-img" alt="" src=""/>Defect products: @_machine?.Defects
                        </label>
                    </li>
                }
                @if (_acceptableCheck)
                {
                    <li>
                        <label>
                            <img class="variable-img" alt="" src=""/>Acceptable products: @_machine?.Acceptable
                        </label>
                    </li>
                }
            </ul>
        </div>
        <div class="machine-settings">
            <label><InputCheckbox @bind-Value="_temperatureCheck"/> Temperature</label><br/>
            <label><InputCheckbox @bind-Value="_humidityCheck"/> Humidity</label><br/>
            <label><InputCheckbox @bind-Value="_vibrationCheck"/> Vibration</label><br/>
            <label><InputCheckbox @bind-Value="_defectsCheck"/> Defect products</label><br/>
            <label><InputCheckbox @bind-Value="_acceptableCheck"/> Acceptable products</label><br/>
        </div>
    </div>
    <div class="machine-maintenance">

    </div>
</div>
}

@if (_error is not null)
{
    <div class="error_message">@_error</div>
}

@code {
    private bool _temperatureCheck;
    private bool _humidityCheck;
    private bool _vibrationCheck;
    private bool _defectsCheck;
    private bool _acceptableCheck;
    private bool _loading = true;
    private string _loadingMessage;
    private string? _error;

    private MachineControl? _machine;
    private static int _machineId;
    private static string? _machineURL;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        _error = null;

        var loadingTask = LoadingAnimation();
        
        try
        {
            await using var conn = await Db.OpenAsync();   // pooled under the hood
            await using var cmd  = conn.CreateCommand();

            cmd.CommandText = @"SELECT m.machineURL, m.machineId 
                                FROM public.user_table u
                                JOIN public.machines m ON u.machine_id = m.machineId
                                WHERE u.token = @token;
            ";
            var token = "test";
            cmd.Parameters.AddWithValue("@token", token);
            
            await using var rdr = await cmd.ExecuteReaderAsync();

            if (await rdr.ReadAsync())
            {
                _machineId = rdr.GetInt32(rdr.GetOrdinal("machineId"));
                _machineURL = rdr.GetString(rdr.GetOrdinal("machineURL"));
                
                _machine = new MachineControl(_machineId, _machineURL);
            }
            else
            {
                _error = "No machines found.";
            }
        }
        catch (Exception ex)
        {
            _error = "Database error: " + ex.Message;
        }
        finally
        {
            _loading = false;
            await InvokeAsync(StateHasChanged);
        }

        await loadingTask;
    }

    private async Task LoadingAnimation()
    {
        while (_loading)
        {
            _loadingMessage = "Loading";
            for (int i = 0; i < 3 && _loading; i++)
            {
                await Task.Delay(250);
                _loadingMessage += ".";
                await InvokeAsync(StateHasChanged);
            }
        }
    }
}