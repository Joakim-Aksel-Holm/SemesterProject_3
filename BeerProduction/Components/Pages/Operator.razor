@page "/o-overview"
@using BeerProduction.Services
@using System.Timers
@using BeerProduction.Components.Model
@using BeerProduction.Enums
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateService AuthenticationStateService
@inject DatabaseConnection Db
@inject NavigationManager NavigationManager
@implements IDisposable
@rendermode InteractiveServer

<link rel="stylesheet" href="css/operatorStyle.css"/>
<link rel="stylesheet" href="/css/machinecontrol.css">
<link rel="stylesheet" href="/css/homeStyle.css">

<AuthorizeView Roles="operator,admin">
    <Authorized>
        <div class="machine-view">
    
            <div class="machine-inventory">
                <ol class="ordered-queue">
            
                    <li class="queue-item" >
                        <h4 class="BatchId"> BatchId </h4>
                        <p>Status: venter</p> 
                    </li>


                    <li class="queue-item">
                        <h4 class="BatchId">BatchId</h4>
                        <p>Status: Venter</p>
                    </li>

                    <li class="queue-item">
                        <h4 class="BatchId">BatchId</h4>
                        <p>Status: Venter</p>
                    </li>
                </ol>
            </div>
            @if (MachineControlService == null)
            {
                <p>Loading machine...</p>
            }
            else
            {
                <div class="machine-meter">
                    <div class="variables">
                        <ul>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/Batch.jpg" alt="Batch" > 
                                <span>
                                    @MachineControlService.GetBatchId()
                                </span>
                            </li>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/Temperature.jpg" alt="Temperature" > 
                                <span>
                                    @MachineControlService.GetTemperature()
                                </span>
                            </li>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/Humidity.jpg" alt="Humidity"> 
                                <span>
                                    @MachineControlService.GetHumidity()
                                </span>
                            </li>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/AmountToProduce.jpg" alt="Amount to produce">
                                <span>
                                    @MachineControlService.GetAmount()
                                </span>
                            </li>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/Produced.jpg" alt="Produced" > 
                                <span>
                                    @MachineControlService.GetProduced()
                                </span>
                            </li>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/AcceptableProducts.jpg" alt="Acceptable Products" > 
                                <span>
                                    @MachineControlService.GetAcceptable()
                                </span>
                            </li>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/DefectProduct.jpg" alt="Defect Products"> 
                                <span>
                                    @MachineControlService.GetDefects()
                                </span>
                            </li>
                            <li>
                                <img class="VaribaleLogo" src="../assets/VariablesLogo/SuccesRate.jpg" alt=" Succesrate"> 
                                <span>
                                    @MachineControlService.LiveSuccesRate() %
                                </span>
                            </li>
                        </ul>

                    </div>
                </div>
                <div class="Machine-bottom">
            
                    <div class="ButtonAlert">
                        <button class="AlertButton">
                            ALERT
                        </button>

                    </div>
                </div>
            }
        </div>
        
        <h1>Machine control</h1>

        <div class="parent">
            <div class="child1">
                <div class="div1">
                    <button @onclick="startMachine">Start</button>
                </div>
                <div class="div2">
                    <button @onclick="stopMachine">Stop</button>
                </div>
                <div class="div3">
                    <button @onclick="resetMachine">Reset</button>
                </div>
                <div class="div4">
                    <button @onclick="clearMachine">Clear</button>
                </div>
                <div class="div5">
                    <button @onclick="abortMachine">Abort</button>
                </div>
            
            </div>
            
            <div class="child2" >
                <div class="div6">
                    <label for="BeerType">Select a Beer type</label>
                    <select class="pulldown1" @bind="SelectedBeerType" id="BeerType">
                        <option value="-1" disabled>Select a beer type</option>
                        <option value="0">Pilsner</option>
                        <option value="1">Wheat</option>
                        <option value="2">IPA</option>
                        <option value="3">Stout</option>
                        <option value="4">Ale</option>
                        <option value="5">Alcohol free</option>
                    </select>

                </div>

                <div class="priority">
                    <label for="Priority">Select a Beer priority</label>
                    <select class="pulldown1" @bind="SelectedPriority" id="Priority">
                        <option value="-1" disabled>Select a priority type</option>
                        <option value="0">Low</option>
                        <option value="1">Medium</option>
                        <option value="2">High</option>
                    </select>
                </div>

                <div class="div7">
                    @* Form for adding batch size and batch speed *@
                    <EditForm Model="@batchForm" Context="batch">
                        <label>
                            Amount:
                            <InputNumber class="kasser" @bind-Value="batchForm.Size"/>
                        </label>

                        <label>
                            Speed:
                            <InputNumber class="kasser" @bind-Value="batchForm.Speed"/>
                        </label>
                    </EditForm>
                </div>
                <div class="div8">
                    <label for="BatchButton">Add to batch</label>
                    <button class="AddBatch" id="BatchButton" @onclick="AddBatchButton">Add Batch</button>
                </div>

                <div class="div9">
                    <label for="SeePriority">See batch priority</label>
                    <button class="BatchPriority" id="SeePriority" @onclick="SeeBatchPriority">
                        Batch Priority
                    </button>
                </div>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        @{
            NavigationManager.NavigateTo("/login");
        }
    </NotAuthorized>
</AuthorizeView>



@code {
    [Parameter] public MachineControlService MachineControlService { get; set; } = null!;
    int id = 1;
    private Timer? _refreshTimer;
    private string? _userId;
    private MachineControl? _machineControl;
    
    private int SelectedBeerType { get; set; } = -1;
    private int SelectedPriority { get; set; } = -1;

    private BatchForm batchForm = new();

    @* private BatchService batchService = new(); *@

    private BatchQueue BatchQueue = new();

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(50);
        
        _userId = AuthenticationStateService.GetUserId();

        if (string.IsNullOrEmpty(_userId) || !int.TryParse(_userId, out var userIdInt))
        {
            return;
        }

        try
        {
            await using var conn = await Db.OpenAsync(); // pooled under the hood
            await using var cmd = conn.CreateCommand();

            cmd.CommandText = @"SELECT u.user_id, m.id, m.url, m.name
                                FROM public.user_machine u 
                                JOIN public.machine_table m ON u.machine_id = m.id
                                WHERE u.user_id = @userId";

            cmd.Parameters.AddWithValue("@userId", userIdInt);

            await using var rdr = await cmd.ExecuteReaderAsync();

            if (await rdr.ReadAsync())
            {
                var machineId = rdr.GetInt32(rdr.GetOrdinal("id"));
                var machineUrl = rdr.GetString(rdr.GetOrdinal("url"));
                var machineName = rdr.GetString(rdr.GetOrdinal("name"));

                Console.WriteLine($"Connection test result: {rdr}");

                _machineControl = new MachineControl(machineId, machineUrl, machineName);

                await _machineControl.TryConnectAsync();

                MachineControlService = new MachineControlService(_machineControl, new BatchQueue());
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"error: {e}");
        }
    }

    protected override void OnInitialized()
    {
        _refreshTimer = new Timer(200);
        _refreshTimer.Elapsed += async (_, _) => await OnTimerElapsed();
        _refreshTimer.AutoReset = true;
        _refreshTimer.Enabled = true;
        
    }

    private async Task OnTimerElapsed()
    {
        if (MachineControlService != null)
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
    }
    
    private string GetTemperatureClass(decimal temperature)
    {
        return temperature switch
        {
            > 70 => "text-danger",
            > 60 => "text-warning",
            _ => "text-success"
        };
    }

    private string GetProgressBarClass(int progress)
    {
        return progress switch
        {
            >= 90 => "bg-success",
            >= 50 => "bg-primary",
            _ => "bg-info"
        };
    }
    
    private async Task abortMachine() => await MachineControlService.AbortCommandAsync();
    private async Task startMachine() => await MachineControlService.AutomatedStart();
    private async Task stopMachine() => await MachineControlService.StopMachineAsync();
    private async Task resetMachine() => await MachineControlService.ResetCommandAsync();
    private async Task clearMachine() => await MachineControlService.ClearCommandAsync();


    private void AddBatchButton()
    {
        // 1. Get the priority from the dropdown
        var priorityEnum = (BatchPriority)SelectedPriority;

        // 2. Create the batch object
        // We use priorityEnum here so the object knows its own priority
        Batch batch = new Batch(id, (BeerType)SelectedBeerType, batchForm.Size, batchForm.Speed, priorityEnum);

        // 3. THIS IS THE CRITICAL CHANGE
        // You must pass 'priorityEnum' as the second argument.
        // If you don't, the Queue defaults it to 'Low', and your sorting won't work.
        MachineControlService.BatchQueue.EnqueueBatch(batch, priorityEnum);

        id++;
    }

    private void SeeBatchPriority()
    {
        Console.WriteLine("All batches in queue\n");
        // Use MachineControlService.BatchQueue instead
        MachineControlService.BatchQueue.BatchQueuePrint();
    }
}